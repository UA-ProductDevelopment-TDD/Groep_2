<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grove Vision AI Component Test</title>
    <style>
        /* Styling voor de testpagina */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            text-align: center;
            max-width: 800px;
            padding: 20px;
        }

        h1 { color: #8dc215; margin-bottom: 10px; }
        p { color: #aaa; margin-bottom: 30px; }

        /* De layout van onze camera grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Vision AI Component Test</h1>
        <p>Testpagina voor lokale netwerkweergave (192.168.137.13)</p>

        <div class="grid">
            <vision-ai-stream ip="192.168.137.166" res="0"></vision-ai-stream>
        </div>
    </div>

    <script>
        class VisionAiStream extends HTMLElement {
            constructor() {
                super();
                this.attachShadow({ mode: 'open' });
            }

            connectedCallback() {
                // Haal instellingen uit de attributen of gebruik defaults
                this.ip = this.getAttribute('ip') || "127.0.0.1";
                this.res = this.getAttribute('res') || "0"; 
                this.render();
                this.startCamera();
            }

            render() {
                this.shadowRoot.innerHTML = `
                <style>
                    :host {
                        display: inline-block;
                        background: #2a2a2a;
                        border: 2px solid #444;
                        border-radius: 15px;
                        padding: 15px;
                        box-shadow: 0 10px 20px rgba(0,0,0,0.3);
                        transition: transform 0.2s;
                    }
                    :host(:hover) { transform: scale(1.02); border-color: #8dc215; }
                    .container { display: flex; flex-direction: column; align-items: center; }
                    canvas { 
                        background: #000; 
                        width: 240px; 
                        height: 240px; 
                        border-radius: 8px;
                        image-rendering: pixelated; /* Voor scherpe 240x240 weergave */
                        border: 1px solid #111;
                    }
                    .info { margin-top: 10px; text-align: center; }
                    .ip-label { font-weight: bold; font-size: 14px; color: #eee; display: block; }
                    .status { font-size: 11px; color: #8dc215; margin-top: 4px; }
                    .error { color: #ff4444; }
                </style>
                <div class="container">
                    <canvas id="preview"></canvas>
                    <div class="info">
                        <span class="ip-label">Camera: ${this.ip}</span>
                        <div id="status" class="status">Initialiseren...</div>
                    </div>
                </div>
                `;
            }

            async startCamera() {
                const canvas = this.shadowRoot.getElementById('preview');
                const status = this.shadowRoot.getElementById('status');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                const baseHost = `http://${this.ip}`;

                try {
                    // 1. Configuratie sturen
                    const sensorCmd = btoa(`SENSOR=1,1,${this.res}`);
                    await fetch(`${baseHost}/command?base64=${sensorCmd}`, { mode: 'cors' });

                    // 2. Stream activeren
                    const invokeCmd = btoa("INVOKE=-1,0,0");
                    const resp = await fetch(`${baseHost}/command?base64=${invokeCmd}`, { mode: 'cors' });
                    const data = await resp.json();

                    if (data.code === 0) {
                        status.innerText = "â— LIVE VERBONDEN";
                        this.readStream(`${baseHost}:8080/stream/result`, ctx, img, canvas, status);
                    } else {
                        throw new Error("Device error code: " + data.code);
                    }
                } catch (err) {
                    status.innerText = "OFFLINE / NIET GEVONDEN";
                    status.classList.add('error');
                    console.error("Camera Error:", err);
                }
            }

            async readStream(url, ctx, img, canvas, status) {
                try {
                    const response = await fetch(url, { cache: 'no-cache' });
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        let parts = buffer.split('\r\n');
                        buffer = parts.pop();

                        for (let part of parts) {
                            if (part.trim()) {
                                try {
                                    const result = JSON.parse(part);
                                    if (result.data && result.data.image) {
                                        img.onload = () => {
                                            canvas.width = img.width;
                                            canvas.height = img.height;
                                            ctx.drawImage(img, 0, 0);
                                        };
                                        img.src = `data:image/jpeg;base64,${result.data.image}`;
                                    }
                                } catch (e) { /* Sla corrupte JSON over */ }
                            }
                        }
                    }
                } catch (e) {
                    status.innerText = "STREAM ONDERBROKEN";
                    status.classList.add('error');
                }
            }
        }
        customElements.define('vision-ai-stream', VisionAiStream);
    </script>
</body>
</html>