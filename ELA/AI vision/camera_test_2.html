<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>AI Vision - Dynamisch IP Test</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #eee; padding: 40px; display: flex; flex-direction: column; align-items: center; }
        
        .controls { 
            background: #1e1e1e; padding: 20px; border-radius: 12px; border: 1px solid #333; 
            margin-bottom: 30px; display: flex; gap: 10px; align-items: center;
        }

        input { 
            background: #000; border: 1px solid #444; color: #8dc215; padding: 10px; 
            border-radius: 6px; outline: none; font-family: monospace; font-size: 16px;
        }

        button { 
            background: #8dc215; color: #000; border: none; padding: 10px 20px; 
            border-radius: 6px; cursor: pointer; font-weight: bold; 
        }

        button:hover { background: #a5d63f; }

        .dashboard { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .data-panel { background: #1e1e1e; border: 1px solid #333; border-radius: 12px; padding: 20px; min-width: 250px; }
        .data-item { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #2a2a2a; }
        .label { color: #888; }
        .value { color: #8dc215; font-family: monospace; }
    </style>
</head>
<body>

    <h1>Vision AI Bediening</h1>

    <div class="controls">
        <label for="ipInput">Camera IP:</label>
        <input type="text" id="ipInput" value="192.168.137.13" placeholder="Bijv. 192.168.1.50">
        <button id="connectBtn">Verbinden</button>
    </div>

    <div class="dashboard">
        <vision-ai-stream id="aiCam" res="0"></vision-ai-stream>

        <div class="data-panel">
            <h2>Live Data</h2>
            <div id="dataOutput"><i>Wachten op verbinding...</i></div>
        </div>
    </div>

    <script>
        class VisionAiStream extends HTMLElement {
            constructor() {
                super();
                this.attachShadow({ mode: 'open' });
                this.controller = null;
            }

            // Methode om van buitenaf een nieuw IP in te stellen
            async connect(newIp) {
                // Stop de huidige stream als die er is
                if (this.controller) this.controller.abort();
                
                this.ip = newIp;
                this.render();
                this.startCamera();
            }

            render() {
                this.shadowRoot.innerHTML = `
                <style>
                    :host { display: inline-block; background: #1e1e1e; border: 1px solid #333; border-radius: 12px; padding: 15px; }
                    .container { position: relative; width: 240px; height: 240px; background: #000; border-radius: 8px; overflow: hidden; }
                    canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; image-rendering: pixelated; }
                    .status { font-size: 11px; margin-top: 10px; text-align: center; color: #8dc215; font-family: monospace; }
                </style>
                <div class="container">
                    <canvas id="videoCanvas"></canvas>
                    <canvas id="overlay"></canvas>
                </div>
                <div id="status" class="status">IDLE</div>
                `;
            }

            async startCamera() {
                const videoCanvas = this.shadowRoot.getElementById('videoCanvas');
                const overlay = this.shadowRoot.getElementById('overlay');
                const status = this.shadowRoot.getElementById('status');
                const vCtx = videoCanvas.getContext('2d');
                const oCtx = overlay.getContext('2d');
                const img = new Image();
                const baseHost = `http://${this.ip}`;

                status.innerText = "VERBINDEN MET " + this.ip + "...";

                try {
                    const sensorCmd = btoa(`SENSOR=1,1,${this.getAttribute('res') || 0}`);
                    await fetch(`${baseHost}/command?base64=${sensorCmd}`, { mode: 'cors' });

                    const invokeCmd = btoa("INVOKE=-1,0,0");
                    const resp = await fetch(`${baseHost}/command?base64=${invokeCmd}`, { mode: 'cors' });
                    const data = await resp.json();

                    if (data.code === 0) {
                        status.innerText = `â— LIVE: ${this.ip}`;
                        this.controller = new AbortController();
                        this.readStream(`${baseHost}:8080/stream/result`, vCtx, oCtx, img, videoCanvas, overlay, this.controller.signal);
                    }
                } catch (err) {
                    status.innerText = "FOUT: " + err.message;
                    status.style.color = "#ff4444";
                }
            }

            async readStream(url, vCtx, oCtx, img, vCanvas, oCanvas, signal) {
                try {
                    const response = await fetch(url, { cache: 'no-cache', signal });
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });
                        let parts = buffer.split('\r\n');
                        buffer = parts.pop();

                        for (let part of parts) {
                            if (part.trim()) {
                                try {
                                    const result = JSON.parse(part);
                                    if (result.data?.image) {
                                        img.onload = () => {
                                            vCanvas.width = oCanvas.width = img.width;
                                            vCanvas.height = oCanvas.height = img.height;
                                            vCtx.drawImage(img, 0, 0);
                                            this.drawBoxes(oCtx, result.data.boxes || []);
                                            this.dispatchEvent(new CustomEvent('detection', { detail: result.data.boxes || [] }));
                                        };
                                        img.src = `data:image/jpeg;base64,${result.data.image}`;
                                    }
                                } catch (e) {}
                            }
                        }
                    }
                } catch (e) {
                    if (e.name !== 'AbortError') console.error("Stream stop:", e);
                }
            }

            drawBoxes(ctx, boxes) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.strokeStyle = "#8dc215";
                ctx.lineWidth = 2;
                boxes.forEach(box => {
                    const [x, y, w, h] = box;
                    ctx.strokeRect(x - w / 2, y - h / 2, w, h);
                });
            }
        }
        customElements.define('vision-ai-stream', VisionAiStream);

        // --- INTERACTIE LOGICA ---
        const ipInput = document.getElementById('ipInput');
        const connectBtn = document.getElementById('connectBtn');
        const cam = document.getElementById('aiCam');
        const output = document.getElementById('dataOutput');

        // Verbind bij klik op knop
        connectBtn.onclick = () => {
            cam.connect(ipInput.value);
        };

        // Verbind automatisch bij opstarten
        window.onload = () => cam.connect(ipInput.value);

        // Data weergave logica
        cam.addEventListener('detection', (e) => {
            const boxes = e.detail;
            if (boxes.length > 0) {
                const b = boxes[0];
                output.innerHTML = `
                    <div class="data-item"><span class="label">X Pos:</span><span class="value">${b[0]}</span></div>
                    <div class="data-item"><span class="label">Y Pos:</span><span class="value">${b[1]}</span></div>
                    <div class="data-item"><span class="label">Score:</span><span class="value">${b[4]}%</span></div>
                `;
            } else {
                output.innerHTML = '<i>Geen objecten gedetecteerd</i>';
            }
        });
    </script>
</body>
</html>